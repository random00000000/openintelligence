<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ollama Multi-Agent Chat</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 20px auto; }
    #chat { border: 1px solid #444; padding: 10px; height: 400px; overflow-y: auto; white-space: pre-wrap; }
    .msg-user { font-weight: bold; margin-bottom: 4px; }
    .msg-assistant { color: #0a0; margin-bottom: 4px; }
    .msg-final-reply { color: #0066cc; font-weight: 500; margin-bottom: 4px; }
    .msg-meta { color: #666; font-style: italic; margin-bottom: 4px; }
    textarea { width: 100%; box-sizing: border-box; }
    button { margin-top: 8px; }
    label { display: block; margin: 8px 0; }
    input[type="number"] { width: 60px; }
  </style>
</head>
<body>
  <h1>Ollama Multi-Agent Chat</h1>

  <label>
    System prompt (optional, global for everyone & the orchestrator):
    <textarea id="system" rows="2" placeholder="You are a helpful assistant."></textarea>
  </label>

  <label>
    Team roles (one per line, format: Name or Name: description):
    <textarea id="roles" rows="4" placeholder="Architect
Skeptic
Tarentino style Movie Writer
Netflix TV Series Writer"></textarea>
  </label>

  <label>
    Number of assistants in the meeting (1–8):
    <input id="agentCount" type="number" min="1" max="8" value="3" />
  </label>

  <div id="chat"></div>

  <label>
    Your message:
    <textarea id="input" rows="3" placeholder="Type a message..."></textarea>
  </label>
  <button id="sendBtn">Send</button>

  <script>
    const API_URL = 'http://localhost:11434/api/chat'; // local Ollama API
    const MODEL   = 'deepseek-r1:8b';                  // change to whatever you pulled

    const chatDiv      = document.getElementById('chat');
    const inputEl      = document.getElementById('input');
    const systemEl     = document.getElementById('system');
    const rolesEl      = document.getElementById('roles');
    const sendBtn      = document.getElementById('sendBtn');
    const agentCountEl = document.getElementById('agentCount');

    // Toggle this to hide/show the panel notes in the UI
    const SHOW_PANEL_NOTES = true;

    // UI-only chat log (not yet used for context)
    const messages = [];

    // NEW localStorage keys (v2 so we don't load old Hardcore Survival prompts)
    const STORAGE_KEY_SYSTEM      = 'ollama_multi_agent_system_v2';
    const STORAGE_KEY_ROLES       = 'ollama_multi_agent_roles_v2';
    const STORAGE_KEY_AGENT_COUNT = 'ollama_multi_agent_agent_count_v2';

    // Load saved settings on startup
    (function loadSavedSettings() {
      try {
        const savedSystem = localStorage.getItem(STORAGE_KEY_SYSTEM);
        const savedRoles  = localStorage.getItem(STORAGE_KEY_ROLES);
        const savedCount  = localStorage.getItem(STORAGE_KEY_AGENT_COUNT);

        if (savedSystem !== null) {
          systemEl.value = savedSystem;
        }

        if (savedRoles !== null) {
          rolesEl.value = savedRoles;
        }

        if (savedCount !== null) {
          agentCountEl.value = savedCount;
        }
      } catch (e) {
        console.warn('Could not load saved settings:', e);
      }
    })();

    // Agent system prompts mapped by name - agents pick their prompt from their name
    const AGENT_SYSTEM_PROMPTS = {
      'Architect': 'You think in structure, steps, and frameworks. You design clear, step-by-step solutions.',
      'Skeptic': 'You look for flaws, missing info, and risks. You point out what will break or confuse the user.',
      'Pragmatist': 'You focus on simple, practical, shippable solutions. You remove bloat and keep what matters.',
      'Researcher': 'You recall patterns, best practices, and references relevant to the current question.',
      'Tarentino style Movie Writer': 'You are a creative writer specializing in Tarantino-style dialogue, nonlinear narratives, and cinematic storytelling. Focus on sharp dialogue, unexpected twists, and pop culture references.',
      'Tarantino style Movie Writer': 'You are a creative writer specializing in Tarantino-style dialogue, nonlinear narratives, and cinematic storytelling. Focus on sharp dialogue, unexpected twists, and pop culture references.',
      'Netflix TV Series Writer': 'You are a TV series writer who understands pacing, character arcs, and episodic storytelling. Focus on binge-worthy content, cliffhangers, and character development.',
      'Game Development Assistant': 'You are a game development expert who understands game mechanics, player experience, and technical implementation. Focus on gameplay, balance, and engaging player interactions.'
    };

    // Role-specific scope instructions - defines what each agent should focus on and avoid
    function getRoleScope(agentName, agentSystem) {
      const nameLower = agentName.toLowerCase();
      const systemLower = agentSystem.toLowerCase();
      const combined = nameLower + ' ' + systemLower;

      // Writing-focused roles (screenwriter, writer, novelist, etc.)
      if (combined.match(/\b(writer|screenwriter|novelist|author|script|dialogue|narrative|story|tarantino|cinematic|tv series|movie|film|screenplay)\b/)) {
        return {
          focus: [
            'Dialogue quality, character voice, and authenticity',
            'Narrative structure, pacing, and story beats',
            'Writing style, tone, and voice',
            'Character development and arcs',
            'Scene construction and dramatic tension',
            'Dialogue that reveals character and advances plot',
            'Writing techniques and literary devices'
          ],
          avoid: [
            'Technical implementation details',
            'Code or programming',
            'Game mechanics or system design',
            'Business strategy or marketing',
            'Technical architecture or infrastructure'
          ],
          examples: 'If asked about a story, suggest dialogue improvements, character motivations, or narrative structure. If asked about coding or game design, acknowledge it\'s outside your expertise and focus only on any writing/narrative aspects.'
        };
      }

      // Game development roles
      if (combined.match(/\b(game|gaming|gameplay|game design|game mechanics|player experience|game development|game dev)\b/)) {
        return {
          focus: [
            'Game mechanics and systems',
            'Player experience and engagement',
            'Gameplay loops and progression',
            'Balance and difficulty curves',
            'Game design principles',
            'Player psychology and motivation',
            'Technical game implementation'
          ],
          avoid: [
            'Creative writing or dialogue',
            'Screenwriting or film structure',
            'Business strategy unrelated to games',
            'Literary analysis'
          ],
          examples: 'If asked about game design, suggest mechanics, balance, or player experience improvements. If asked about writing dialogue, focus only on how it serves gameplay or player engagement.'
        };
      }

      // Technical/Programming roles
      if (combined.match(/\b(programmer|developer|coder|software|code|programming|technical|engineer|architect|system design|api|algorithm)\b/)) {
        return {
          focus: [
            'Code structure and architecture',
            'Technical implementation',
            'Best practices and patterns',
            'Performance and optimization',
            'System design and scalability',
            'API design and interfaces',
            'Debugging and error handling'
          ],
          avoid: [
            'Creative writing or dialogue',
            'Game design mechanics',
            'Business strategy',
            'Literary or narrative analysis'
          ],
          examples: 'If asked about coding, suggest technical solutions, patterns, or architecture. If asked about writing or game design, acknowledge it\'s outside your technical expertise.'
        };
      }

      // Business/Strategy roles
      if (combined.match(/\b(business|strategy|marketing|product|manager|executive|consultant|analyst)\b/)) {
        return {
          focus: [
            'Business strategy and planning',
            'Market analysis and positioning',
            'Product development and features',
            'User needs and market fit',
            'ROI and business metrics',
            'Go-to-market strategies'
          ],
          avoid: [
            'Technical code implementation',
            'Creative writing details',
            'Game mechanics specifics'
          ],
          examples: 'If asked about business, suggest strategic approaches, market considerations, or product decisions. If asked about technical details, focus on business impact rather than implementation.'
        };
      }

      // Generic/General roles (default)
      return {
        focus: [
          'Your specific domain expertise',
          'Practical and actionable suggestions',
          'Critical analysis and improvements',
          'Best practices in your field'
        ],
        avoid: [
          'Areas clearly outside your expertise',
          'Topics unrelated to your specialization'
        ],
        examples: 'Focus on your area of expertise. If the question is outside your domain, acknowledge it and focus only on aspects that relate to your specialization.'
      };
    }

    // Default templates if no custom roles are given
    const DEFAULT_AGENT_TEMPLATES = [
      { name: 'Architect', system: AGENT_SYSTEM_PROMPTS['Architect'] },
      { name: 'Skeptic', system: AGENT_SYSTEM_PROMPTS['Skeptic'] },
      { name: 'Pragmatist', system: AGENT_SYSTEM_PROMPTS['Pragmatist'] },
      { name: 'Researcher', system: AGENT_SYSTEM_PROMPTS['Researcher'] }
    ];

    function clampAgentsCount(raw) {
      let n = parseInt(raw, 10);
      if (isNaN(n)) n = 1;
      n = Math.max(1, n);
      n = Math.min(8, n);
      return n;
    }

    function buildAgentsFromRolesText(n) {
      const text = rolesEl.value.trim();
      if (!text) {
        // Fall back to defaults
        return DEFAULT_AGENT_TEMPLATES
          .slice(0, n)
          .map(a => ({ name: a.name, system: a.system }));
      }

      const lines = text.split('\n')
        .map(l => l.trim())
        .filter(Boolean);

      const agents = [];

      for (let i = 0; i < lines.length && agents.length < n; i++) {
        const line = lines[i];
        const parts = line.split(':');
        const namePart = (parts[0] || '').trim();
        const descPart = parts.slice(1).join(':').trim();

        const name = namePart || `Agent ${agents.length + 1}`;

        let systemPrompt;
        // First, try to get system prompt from name mapping
        if (AGENT_SYSTEM_PROMPTS[name]) {
          systemPrompt = AGENT_SYSTEM_PROMPTS[name];
        } else if (descPart) {
          // If not found in mapping but description provided, use description
          systemPrompt = descPart;
        } else {
          // If user only wrote a name (not in mapping), generate default
          systemPrompt = `Act as ${name}, a highly capable specialist. Provide high-quality ideas, critiques, and improvements in your domain.`;
        }

        agents.push({
          name,
          system: systemPrompt
        });
      }

      // If fewer lines than n, pad with generic agents
      while (agents.length < n) {
        const idx = agents.length + 1;
        agents.push({
          name: `Agent ${idx}`,
          system: `Act as Agent ${idx}, an expert assistant. Provide sharp, concrete suggestions and critiques.`
        });
      }

      return agents;
    }

    function getActiveAgents() {
      const n = clampAgentsCount(agentCountEl.value);
      return buildAgentsFromRolesText(n);
    }

    function addMessage(role, content) {
      const div = document.createElement('div');
      if (role === 'meta') {
        div.className = 'msg-meta';
        div.textContent = content;
      } else {
        div.className = 'msg-' + role;
        div.textContent = (role === 'user' ? 'You: ' : 'Bot: ') + content;
      }
      chatDiv.appendChild(div);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    async function callOllama(chatMessages) {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: MODEL,
          messages: chatMessages,
          stream: false
        })
      });

      if (!res.ok) {
        throw new Error('HTTP ' + res.status);
      }

      const data = await res.json();
      return data.message?.content || '(no content)';
    }

    async function sendMessage() {
      const text = inputEl.value.trim();
      if (!text) return;

      // Show user message in UI
      messages.push({ role: 'user', content: text });
      addMessage('user', text);
      inputEl.value = '';
      sendBtn.disabled = true;

      const agents = getActiveAgents();
      const globalSystem = systemEl.value.trim();

      const agentReplies = [];
      let panelTranscript = ''; // all expert notes so far

      try {
        // 1) Run each assistant sequentially as a PANEL of INTERNAL EXPERTS
        for (const agent of agents) {
          addMessage('meta', `[${agent.name} is thinking...]`);

          const agentMessages = [];

          if (globalSystem) {
            agentMessages.push({
              role: 'system',
              content: globalSystem
            });
          }

          // Get role-specific scope
          const roleScope = getRoleScope(agent.name, agent.system);
          const focusList = roleScope.focus.map(f => `• ${f}`).join('\n');
          const avoidList = roleScope.avoid.map(a => `• ${a}`).join('\n');

          // Check if this agent is told to stay silent
          const agentNameLower = agent.name.toLowerCase();
          const textLower = text.toLowerCase();
          // Check for patterns like "agent name stay silent", "agent name don't respond", etc.
          const staySilentPatterns = [
            new RegExp(`\\b${agentNameLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\s+(stay|remain|keep|be)\\s+(silent|quiet|mute)`, 'i'),
            new RegExp(`\\b(stay|remain|keep|be)\\s+(silent|quiet|mute).*\\b${agentNameLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i'),
            new RegExp(`\\b${agentNameLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\s+(don'?t|do not|should not|must not)\\s+(respond|speak|talk|say|answer)`, 'i'),
            new RegExp(`\\b(don'?t|do not|should not|must not)\\s+(let|have|allow).*\\b${agentNameLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b.*(respond|speak|talk|say|answer)`, 'i')
          ];
          const shouldStaySilent = staySilentPatterns.some(pattern => pattern.test(textLower));
          
          // Check if this agent is being addressed directly
          const agentNameWords = agentNameLower.split(/\s+/);
          const isAddressed = agentNameWords.some(word => {
            const wordPattern = new RegExp(`\\b${word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
            return wordPattern.test(textLower);
          });

          // Role for this agent as an internal note-generator with role-specific scope
          agentMessages.push({
            role: 'system',
            content:
              `You are ${agent.name}. ${agent.system}\n\n` +
              `CRITICAL: Your exact name/identity is "${agent.name}". Always remember this.\n\n` +
              `You are participating in a team meeting with other experts. Act like a human team member would in a real meeting.\n` +
              `You write internal notes that help the team, but respond naturally and contextually.\n\n` +
              `=== YOUR SPECIALIZATION SCOPE ===\n` +
              `FOCUS ON:\n${focusList}\n\n` +
              `AVOID:\n${avoidList}\n\n` +
              `EXAMPLES: ${roleScope.examples}\n\n` +
              `=== CRITICAL BEHAVIOR RULES ===\n` +
              `• Act like a REAL HUMAN in a meeting. Humans don't randomly talk about their job specialization unless it's relevant.\n` +
              `• If the user asks you to do a simple task (like pick a number, state your name, etc.), just do the task. Don't explain how it relates to your expertise.\n` +
              `• Only discuss your specialization when:\n` +
              `  - The user explicitly asks about your area of expertise\n` +
              `  - The task/problem directly relates to your specialization\n` +
              `  - You're providing relevant input to a complex problem in your domain\n` +
              `• If the user just greets you, respond with a simple greeting. No expertise commentary.\n` +
              `• If asked a simple question outside your domain, answer it simply. Don't force connections to your expertise.\n` +
              `• Remember: In real meetings, people don't lecture about their job when asked to do something simple. They just do it.\n` +
              `• If the user tells you to stay silent, remain quiet, or not respond, you MUST stay silent and not provide any response.`
          });

          // Include full conversation history for context (both user and assistant messages)
          // Skip the last message as it's the current one we're processing
          for (let i = 0; i < messages.length - 1; i++) {
            const msg = messages[i];
            agentMessages.push({
              role: msg.role,
              content: msg.content
            });
          }

          // Build panel-style user prompt for this agent
          const panelContext = panelTranscript
            ? `Here are notes from other team members so far:\n\n${panelTranscript}\n\n`
            : '';

          // Check if user is asking for a number
          const askingForNumber = /\b(number|random|digit|value|num|invent.*number|pick.*number)\b/i.test(text);
          
          // Detect if this is a simple greeting or minimal context
          const isSimpleGreeting = /^(hi|hello|hey|greetings|good (morning|afternoon|evening))[\s!.,]*$/i.test(text.trim());
          const isMinimalContext = text.trim().length < 20 && !/\?/.test(text);
          
          // Detect simple tasks that don't need expertise commentary
          const isSimpleTask = askingForNumber || 
            /\b(pick|choose|select|say|tell|state|give|provide).*(number|name|word|color|item)\b/i.test(text);

          // Build agent-specific instruction awareness
          let agentIdentityPrompt = `=== YOUR IDENTITY ===\n` +
            `Your exact name is: "${agent.name}"\n` +
            `Remember this identity clearly. If the user addresses you by name or tells you to do something, follow their instructions.\n\n`;
          
          if (shouldStaySilent) {
            agentIdentityPrompt += `=== CRITICAL INSTRUCTION ===\n` +
              `The user has explicitly told you (${agent.name}) to STAY SILENT.\n` +
              `You MUST NOT respond. Do not provide any notes, numbers, or commentary.\n` +
              `Simply acknowledge internally that you are staying silent as requested.\n` +
              `Output only: "[Staying silent as requested]"\n`;
          } else if (isAddressed && !isSimpleGreeting) {
            agentIdentityPrompt += `=== YOU ARE BEING ADDRESSED ===\n` +
              `The user's message appears to be addressing you (${agent.name}) specifically.\n` +
              `Pay close attention to what they're asking you to do.\n\n`;
          }

          const agentPrompt =
            agentIdentityPrompt +
            `=== USER'S CURRENT MESSAGE ===\n"${text}"\n\n` +
            (panelContext ? panelContext : '') +
            `=== YOUR TASK ===\n` +
            (shouldStaySilent ?
              `STAY SILENT. Do not respond. Output only: "[Staying silent as requested]"` :
              isSimpleGreeting ? 
              `This is a simple greeting. Respond naturally like a human would in a meeting:\n` +
              `• Just greet them back warmly and briefly (e.g., "Hi! How can I help?" or "Hello! Ready to work.")\n` +
              `• Do NOT provide bullet points, detailed notes, or talk about your expertise.\n` +
              `• Keep it conversational and human-like.\n` :
              isSimpleTask ?
              `This is a simple task request. Act like a human would - just do the task without unnecessary commentary:\n` +
              (askingForNumber ?
                `• Provide your random number clearly (e.g., "My number: 7" or just "7")\n` +
                `• Do NOT explain how this relates to your specialization.\n` +
                `• Do NOT provide bullet points about machine learning, GPT models, or your expertise.\n` +
                `• Just pick a number and state it. That's it.\n` :
                `• Do the task directly and briefly.\n` +
                `• Do NOT provide extensive commentary about your expertise unless the task specifically requires it.\n` +
                `• Act naturally - humans don't lecture about their job when doing simple tasks.\n`) :
              isMinimalContext ?
              `This is a brief message with minimal context. Respond naturally and concisely:\n` +
              `• Address the user's message directly and briefly.\n` +
              `• Only mention your expertise if it's actually relevant to what they're asking.\n` +
              `• Do NOT provide extensive bullet points or detailed analysis yet.\n` +
              `• Wait for more context before diving deep.\n` :
              `The user has provided substantial context. Respond as a team member would:\n` +
              `• Address the user's message directly first.\n` +
              `• Only discuss your specialization if it's actually relevant to the task/question.\n` +
              `• If the task is simple or outside your domain, just respond naturally without forcing expertise connections.\n` +
              `• Only provide detailed bullet points if:\n` +
              `  - The user explicitly asks about your area of expertise, OR\n` +
              `  - The problem directly relates to your specialization, OR\n` +
              `  - You're contributing relevant domain knowledge to a complex problem\n` +
              `• If providing expertise, keep it relevant and concise (2-5 bullet points max).\n` +
              `• Do NOT write the final answer.\n` +
              `• Do NOT write scenes, dialogue, or long paragraphs.\n` +
              `• Remember: Real humans don't randomly talk about their job. Only mention your expertise when it's actually useful.`);

          agentMessages.push({
            role: 'user',
            content: agentPrompt
          });

          let reply;
          try {
            if (shouldStaySilent) {
              // Skip the API call if agent should stay silent
              reply = '[Staying silent as requested]';
            } else {
              reply = await callOllama(agentMessages);
              // Double-check if the agent tried to respond when told to stay silent
              if (shouldStaySilent && !reply.includes('[Staying silent')) {
                reply = '[Staying silent as requested]';
              }
            }
          } catch (err) {
            reply = `Error from ${agent.name}: ${err.message}`;
          }

          agentReplies.push({ agentName: agent.name, text: reply, stayedSilent: shouldStaySilent });

          if (SHOW_PANEL_NOTES) {
            if (shouldStaySilent) {
              addMessage('assistant', `${agent.name} (notes):\n[Staying silent as requested]`);
            } else {
              addMessage('assistant', `${agent.name} (notes):\n${reply}`);
            }
          }

          // Update panel transcript for the next expert (skip silent agents)
          if (!shouldStaySilent) {
            panelTranscript += `${agent.name} notes:\n${reply}\n\n`;
          }
        }

        // 2) Orchestrator: read panel notes & answer the user ONCE
        const meetingTranscript = panelTranscript.trim() ||
          agentReplies
            .map(ar => `${ar.agentName} notes:\n${ar.text}`)
            .join('\n\n---\n\n');

        // Extract numbers from expert responses (skip agents that stayed silent)
        const numbers = [];
        const activeAgents = [];
        for (const reply of agentReplies) {
          // Skip agents that stayed silent
          if (reply.stayedSilent || reply.text.includes('[Staying silent')) {
            continue;
          }
          activeAgents.push(reply.agentName);
          // Look for patterns like "number: 42", "random number: 17", "My number is 42", etc.
          const explicitPattern = reply.text.match(/\b(number|random|num|value|digit)[:\s]+(\d+)\b/i);
          if (explicitPattern && explicitPattern[2]) {
            const num = parseInt(explicitPattern[2], 10);
            if (!isNaN(num) && num >= 0 && num <= 1000000) {
              numbers.push({ agent: reply.agentName, number: num });
              continue;
            }
          }
          // Fallback: look for standalone numbers (1-6 digits, likely to be the random number)
          const standaloneNumbers = reply.text.match(/\b(\d{1,6})\b/g);
          if (standaloneNumbers && standaloneNumbers.length > 0) {
            // Take the first reasonable number (not too large, likely the random number)
            for (const match of standaloneNumbers) {
              const num = parseInt(match, 10);
              if (!isNaN(num) && num >= 0 && num <= 1000000) {
                numbers.push({ agent: reply.agentName, number: num });
                break; // Take first valid number from each expert
              }
            }
          }
        }

        // Detect if user gave specific instructions to agents
        const agentInstructions = [];
        for (const agent of agents) {
          const agentNameLower = agent.name.toLowerCase();
          const textLower = text.toLowerCase();
          const staySilentPatterns = [
            new RegExp(`\\b${agentNameLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\s+(stay|remain|keep|be)\\s+(silent|quiet|mute)`, 'i'),
            new RegExp(`\\b(stay|remain|keep|be)\\s+(silent|quiet|mute).*\\b${agentNameLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i'),
            new RegExp(`\\b${agentNameLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\s+(don'?t|do not|should not|must not)\\s+(respond|speak|talk|say|answer)`, 'i')
          ];
          if (staySilentPatterns.some(pattern => pattern.test(textLower))) {
            agentInstructions.push(`${agent.name} was told to stay silent`);
          }
        }

        const orchestratorSystem =
          (globalSystem ? globalSystem + '\n\n' : '') +
          'You are the Orchestrator for a team of expert assistants in a meeting.\n' +
          'You are the ONLY one whose output is shown to the user.\n\n' +
          'RULES:\n' +
          '• Act like a meeting facilitator. Respond naturally and match the user\'s tone and context level.\n' +
          '• If the user just greets you (e.g., "hi", "hello"), respond with a simple, warm greeting. Do NOT provide extensive analysis or meta commentary.\n' +
          '• Your top priority is to answer the user\'s latest message directly and naturally, no matter the domain.\n' +
          '• You have access to the FULL conversation history - all previous user messages and all previous assistant responses.\n' +
          '• Use the internal team notes to understand what the experts are thinking, but respond naturally.\n' +
          '• Pay close attention to the user\'s instructions. If they tell specific agents to stay silent or do specific tasks, respect those instructions.\n' +
          '• If the user asks for numbers from specific experts, only count numbers from those experts (ignore agents told to stay silent).\n' +
          '• If experts provided numbers, aggregate them (e.g., average, sum, or list them) and present the final result clearly.\n' +
          '• If the user asks a simple factual or everyday question (e.g. a time, definition, or small how-to), do NOT turn it into a story or unrelated content.\n' +
          '• If you genuinely cannot know something (like the exact current local time or live external data), say so clearly and briefly.\n' +
          '• Match the user\'s context level: be brief for simple messages, be detailed for complex questions.\n' +
          '• If the user asks for a specific structure or format, follow it precisely.\n';

        // Build full conversation history for orchestrator
        const orchestratorMessages = [
          {
            role: 'system',
            content: orchestratorSystem
          }
        ];

        // Include full conversation history
        for (const msg of messages) {
          orchestratorMessages.push({
            role: msg.role,
            content: msg.content
          });
        }

        // Detect if this is a simple greeting
        const isSimpleGreeting = /^(hi|hello|hey|greetings|good (morning|afternoon|evening))[\s!.,]*$/i.test(text.trim());

        // Add current request with context
        let orchestratorPrompt = 
          `=== USER'S CURRENT REQUEST ===\n"${text}"\n\n` +
          `=== FULL CONVERSATION HISTORY ===\n` +
          `You have access to all previous messages above.\n\n`;

        // Include agent instruction awareness
        if (agentInstructions.length > 0) {
          orchestratorPrompt += 
            `=== IMPORTANT: USER'S SPECIFIC INSTRUCTIONS ===\n` +
            agentInstructions.join('\n') +
            `\n\nPay attention to these instructions. Only count responses from agents who were NOT told to stay silent.\n\n`;
        }

        orchestratorPrompt += `=== INTERNAL TEAM NOTES FROM EXPERTS ===\n${meetingTranscript}\n\n`;

        // If numbers were found, include them
        if (numbers.length > 0) {
          orchestratorPrompt += 
            `=== NUMBERS PROVIDED BY EXPERTS ===\n` +
            numbers.map(n => `${n.agent}: ${n.number}`).join('\n') +
            `\n\nYou MUST aggregate these numbers and provide the final result to the user.\n` +
            (activeAgents.length > 0 ? `\nNote: Only ${activeAgents.join(' and ')} ${activeAgents.length === 1 ? 'was' : 'were'} active. ` +
            `Other agents stayed silent as requested.\n` : '') +
            `\n`;
        }

        orchestratorPrompt += 
          `=== YOUR TASK ===\n` +
          (isSimpleGreeting ?
            `The user just greeted you. Respond naturally like a meeting facilitator would:\n` +
            `• Give a warm, brief greeting back (e.g., "Hi! How can I help?" or "Hello! What would you like to work on?")\n` +
            `• Do NOT provide extensive analysis, meta commentary, or detailed explanations.\n` +
            `• Keep it simple and human-like.\n` :
            numbers.length > 0 ? 
            `CRITICAL: The user asked for numbers. The experts provided: ${numbers.map(n => n.number).join(', ')}. ` +
            `You MUST provide the final aggregated number (e.g., average, sum, or list) clearly in your response.\n` :
            `Now write the FINAL answer for the user, following their instructions exactly.\n` +
            `Focus on their actual question and use the expert notes to inform your answer naturally.\n` +
            `Match their tone and context level - be brief for simple questions, detailed for complex ones.\n`);

        orchestratorMessages.push({
          role: 'user',
          content: orchestratorPrompt
        });

        const finalReply = await callOllama(orchestratorMessages);

        messages.push({ role: 'assistant', content: finalReply });
        // Display final reply with distinct styling
        const div = document.createElement('div');
        div.className = 'msg-final-reply';
        div.textContent = 'Bot: ' + finalReply;
        chatDiv.appendChild(div);
        chatDiv.scrollTop = chatDiv.scrollHeight;

      } catch (err) {
        addMessage('assistant', 'Request failed: ' + err.message);
      } finally {
        sendBtn.disabled = false;
      }
    }

    // Auto-save when user edits system, roles, or agent count
    systemEl.addEventListener('input', () => {
      try {
        localStorage.setItem(STORAGE_KEY_SYSTEM, systemEl.value);
      } catch (e) {
        console.warn('Could not save system prompt:', e);
      }
    });

    rolesEl.addEventListener('input', () => {
      try {
        localStorage.setItem(STORAGE_KEY_ROLES, rolesEl.value);
      } catch (e) {
        console.warn('Could not save roles prompt:', e);
      }
    });

    agentCountEl.addEventListener('change', () => {
      try {
        localStorage.setItem(STORAGE_KEY_AGENT_COUNT, agentCountEl.value);
      } catch (e) {
        console.warn('Could not save agent count:', e);
      }
    });

    sendBtn.addEventListener('click', sendMessage);
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>
