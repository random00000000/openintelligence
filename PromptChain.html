<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Data Processor – Prompt Chain</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 900px;
      margin: 20px auto;
      line-height: 1.4;
    }
    h1 {
      margin-bottom: 8px;
    }
    #steps {
      margin: 16px 0;
      border: 1px solid #444;
      padding: 10px;
      border-radius: 4px;
    }
    .step {
      border-bottom: 1px solid #333;
      padding: 8px 0;
    }
    .step:last-child {
      border-bottom: none;
    }
    .step-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 0.95rem;
    }
    .step-title {
      font-weight: 600;
    }
    .step-remove {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.85rem;
      color: #c00;
    }
    textarea {
      width: 100%;
      box-sizing: border-box;
      font-family: inherit;
    }
    #initialInput, .step-prompt {
      min-height: 70px;
    }
    .step-output {
      margin-top: 4px;
      border: 1px solid #555;
      border-radius: 3px;
      padding: 6px;
      font-size: 0.9rem;
      white-space: pre-wrap;
      max-height: 150px;
      overflow-y: auto;
      background: #111;
      color: #ddd;
    }
    #controls {
      margin-top: 10px;
    }
    button {
      margin-top: 8px;
      padding: 6px 10px;
      cursor: pointer;
    }
    #finalOutput {
      margin-top: 16px;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 8px;
      background: #050505;
      color: #eee;
      white-space: pre-wrap;
      max-height: 220px;
      overflow-y: auto;
    }
    #status {
      margin-top: 6px;
      font-size: 0.85rem;
      color: #666;
    }
    label {
      display: block;
      margin: 8px 0 4px;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>
  <h1>Data Processor – Prompt Chain</h1>
  <p style="font-size:0.9rem; color:#666;">
    Define a sequence of prompts. The output of each step becomes the input of the next one.
  </p>

  <label>
    Global system prompt (optional):
    <textarea id="system" rows="2" placeholder="You are a helpful text-processing assistant."></textarea>
  </label>

  <label>
    Initial input data:
    <textarea id="initialInput" rows="4" placeholder="Paste or type the starting text here..."></textarea>
  </label>

  <div id="steps"></div>

  <div id="controls">
    <button id="addStepBtn">+ Add step</button>
    <button id="runBtn" style="margin-left: 10px;">Run chain</button>
    <button id="clearOutputsBtn" style="margin-left: 10px;">Clear outputs</button>
  </div>

  <div id="status"></div>

  <h2 style="margin-top:18px;">Final output</h2>
  <div id="finalOutput" placeholder="Final result will appear here..."></div>

  <script>
    // -------- CONFIG --------
    const API_URL = 'http://localhost:11434/api/chat'; // your Ollama API
    const MODEL   = 'deepseek-r1:8b';                  // model name

    // -------- DOM --------
    const systemEl       = document.getElementById('system');
    const initialInputEl = document.getElementById('initialInput');
    const stepsContainer = document.getElementById('steps');
    const addStepBtn     = document.getElementById('addStepBtn');
    const runBtn         = document.getElementById('runBtn');
    const clearOutputsBtn= document.getElementById('clearOutputsBtn');
    const finalOutputEl  = document.getElementById('finalOutput');
    const statusEl       = document.getElementById('status');

    // -------- STATE --------
    let stepCounter = 0;

    // -------- HELPERS --------
    function createStep(initialPrompt = '') {
      stepCounter++;

      const step = document.createElement('div');
      step.className = 'step';

      const header = document.createElement('div');
      header.className = 'step-header';

      const title = document.createElement('span');
      title.className = 'step-title';
      title.textContent = 'Step ' + stepCounter;

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'step-remove';
      removeBtn.textContent = 'Remove';
      removeBtn.addEventListener('click', () => {
        stepsContainer.removeChild(step);
        renumberSteps();
      });

      header.appendChild(title);
      header.appendChild(removeBtn);

      const promptArea = document.createElement('textarea');
      promptArea.className = 'step-prompt';
      promptArea.placeholder = 'Describe what this step should do with the input...';
      promptArea.value = initialPrompt;

      const output = document.createElement('div');
      output.className = 'step-output';
      output.textContent = 'Output will appear here...';

      step.appendChild(header);
      step.appendChild(promptArea);
      step.appendChild(output);

      stepsContainer.appendChild(step);
      return step;
    }

    function renumberSteps() {
      const steps = stepsContainer.querySelectorAll('.step');
      let n = 1;
      steps.forEach(step => {
        const titleEl = step.querySelector('.step-title');
        titleEl.textContent = 'Step ' + n;
        n++;
      });
      stepCounter = steps.length;
    }

    async function callOllama(messages) {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: MODEL,
          messages,
          stream: false
        })
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      return data.message?.content || '';
    }

    function setStatus(text) {
      statusEl.textContent = text;
    }

    // -------- CORE: RUN CHAIN --------
    async function runChain() {
      const initialText = initialInputEl.value.trim();
      if (!initialText) {
        alert('Please provide some initial input data.');
        return;
      }

      const steps = stepsContainer.querySelectorAll('.step');
      if (steps.length === 0) {
        alert('Add at least one step.');
        return;
      }

      runBtn.disabled = true;
      addStepBtn.disabled = true;
      clearOutputsBtn.disabled = true;
      setStatus('Running chain...');

      let currentText = initialText;
      const globalSystem = systemEl.value.trim();

      // Clear previous outputs
      finalOutputEl.textContent = '';
      steps.forEach(step => {
        const out = step.querySelector('.step-output');
        out.textContent = 'Output will appear here...';
      });

      try {
        let stepIndex = 0;
        for (const step of steps) {
          stepIndex++;
          const promptEl = step.querySelector('.step-prompt');
          const outputEl = step.querySelector('.step-output');
          const instruction = promptEl.value.trim();

          if (!instruction) {
            outputEl.textContent = '[Skipped – empty prompt]';
            continue;
          }

          outputEl.textContent = 'Running...';

          const messages = [];

          if (globalSystem) {
            messages.push({
              role: 'system',
              content: globalSystem
            });
          }

          // Minimal, explicit instruction: transform "currentText" according to "instruction"
          messages.push({
            role: 'user',
            content:
              'Instruction:\n' + instruction +
              '\n\n--- INPUT START ---\n' +
              currentText +
              '\n--- INPUT END ---\n\n' +
              'Return ONLY the transformed output.'
          });

          const result = (await callOllama(messages)).trim();
          currentText = result || currentText; // if model returns empty, keep previous
          outputEl.textContent = result || '[Empty output]';

          setStatus('Completed step ' + stepIndex + ' of ' + steps.length);
        }

        finalOutputEl.textContent = currentText;
        setStatus('Chain finished.');
      } catch (err) {
        console.error(err);
        setStatus('Error: ' + err.message);
      } finally {
        runBtn.disabled = false;
        addStepBtn.disabled = false;
        clearOutputsBtn.disabled = false;
      }
    }

    function clearOutputs() {
      finalOutputEl.textContent = '';
      const steps = stepsContainer.querySelectorAll('.step-output');
      steps.forEach(out => {
        out.textContent = 'Output will appear here...';
      });
      setStatus('');
    }

    // -------- EVENT WIRES --------
    addStepBtn.addEventListener('click', () => createStep());
    runBtn.addEventListener('click', runChain);
    clearOutputsBtn.addEventListener('click', clearOutputs);

    // Allow Ctrl+Enter / Cmd+Enter on initial input to run chain
    initialInputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        runChain();
      }
    });

    // Start with one empty step by default
    createStep('First, summarize the input clearly in 3–5 bullet points.');
  </script>
</body>
</html>
